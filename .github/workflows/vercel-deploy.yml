name: Vercel Deployment Validation

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate-deployment:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run build
        run: npm run build

      - name: Check for AI references
        run: |
          echo "ğŸ” Checking for AI-related references in code..."
          # Check commit messages in PR
          if git log --oneline -10 | grep -iE "(ai|chatgpt|claude|openai|llm|gpt|assistant)" | grep -v "check for ai"; then
            echo "âŒ Found AI references in commit messages"
            git log --oneline -10 | grep -iE "(ai|chatgpt|claude|openai|llm|gpt|assistant)"
            exit 1
          fi
          
          # Check branch name
          if echo "${{ github.head_ref }}" | grep -iE "(ai|chatgpt|claude|openai|llm|gpt|assistant)"; then
            echo "âŒ Branch name contains AI references: ${{ github.head_ref }}"
            exit 1
          fi
          
          echo "âœ… No AI references found"

      - name: Create deployment validation report
        run: |
          echo "## Deployment Validation Report" > deployment-report.md
          echo "" >> deployment-report.md
          echo "**PR:** #${{ github.event.pull_request.number }}" >> deployment-report.md
          echo "**Branch:** ${{ github.head_ref }}" >> deployment-report.md
          echo "**Commit:** ${{ github.sha }}" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "### Build Status" >> deployment-report.md
          echo "âœ… Build completed successfully" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "### AI Reference Check" >> deployment-report.md
          echo "âœ… No AI references found in code, commits, or branch names" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "### Next Steps" >> deployment-report.md
          echo "1. Merge this PR to trigger Vercel deployment" >> deployment-report.md
          echo "2. Check Vercel dashboard for deployment logs" >> deployment-report.md
          echo "3. Verify deployment at: https://nagaportfolio.vercel.app" >> deployment-report.md

      - name: Upload validation report
        uses: actions/upload-artifact@v4
        with:
          name: deployment-validation-report
          path: deployment-report.md

  deploy-to-vercel:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Vercel
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          echo "ğŸš€ Deployment to Vercel triggered"
          echo "ğŸ“Š Check deployment status at: https://vercel.com/rnagarajanmca/nagaportfolio"
          echo "ğŸŒ Live site: https://nagaportfolio.vercel.app"