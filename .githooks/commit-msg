#!/usr/bin/env bash

# Portfolio Project - Commit Message Validation Hook
#
# This hook enforces the project's contributor attribution policy:
# - NO AI tools (Claude, ChatGPT, Copilot, etc.) in commit history
# - Only human contributors may be attributed in commits
# - AI assistance may be mentioned in commit body only
#
# This is a HARD REQUIREMENT for this project.

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2
SHA1=$3

# Read the commit message
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Function to print colored output
print_error() {
    echo -e "${RED}❌ COMMIT REJECTED${NC}"
    echo -e "${RED}$1${NC}"
}

print_warning() {
    echo -e "${YELLOW}⚠️  WARNING${NC}: $1"
}

print_success() {
    echo -e "${GREEN}✅ $1${NC}"
}

# ============================================================================
# VALIDATION 1: Check for AI tool co-authors (HARD REQUIREMENT)
# ============================================================================

# List of AI tools that are NOT allowed as co-authors
AI_TOOLS=(
    "claude"
    "chatgpt"
    "gpt-4"
    "gpt-3"
    "copilot"
    "bard"
    "gemini"
    "llama"
    "mistral"
    "perplexity"
    "anthropic"
    "openai"
)

# List of AI service email patterns to reject
AI_EMAIL_PATTERNS=(
    "noreply@anthropic.com"
    "noreply@openai.com"
    "noreply@github.com"  # GitHub Copilot
    "noreply@openai.com"
    "ai@"
)

# Check for AI tool co-author trailers
if echo "$COMMIT_MSG" | grep -iq "Co-Authored-By:"; then
    CO_AUTHORS=$(echo "$COMMIT_MSG" | grep -i "Co-Authored-By:")

    for tool in "${AI_TOOLS[@]}"; do
        if echo "$CO_AUTHORS" | grep -iq "$tool"; then
            print_error "Co-author trailer contains AI tool reference: '$tool'"
            echo ""
            echo "Policy Violation: AI tools cannot be listed as co-authors"
            echo ""
            echo "Current trailers:"
            echo "$CO_AUTHORS"
            echo ""
            echo "Solution: Remove the Co-Authored-By trailer for AI tools."
            echo "You can mention AI assistance in the commit message body instead:"
            echo ""
            echo "  Example:"
            echo "    feat(component): improve performance"
            echo ""
            echo "    Optimized rendering with AI assistance."
            echo "    - Used Copilot for code suggestions"
            echo "    - Performance improved by 40%"
            echo ""
            exit 1
        fi
    done

    # Check for AI service email patterns
    for pattern in "${AI_EMAIL_PATTERNS[@]}"; do
        if echo "$CO_AUTHORS" | grep -iq "$pattern"; then
            print_error "Co-author trailer contains AI service email: '$pattern'"
            echo ""
            echo "Policy Violation: AI service emails cannot be used as co-authors"
            echo ""
            echo "Current trailers:"
            echo "$CO_AUTHORS"
            echo ""
            echo "Solution: Only use human contributor email addresses."
            echo ""
            exit 1
        fi
    done
fi

# ============================================================================
# VALIDATION 2: Warn about common AI patterns in message body
# ============================================================================

# Check for common patterns that might indicate the person forgot the policy
if echo "$COMMIT_MSG" | grep -iq "generated by\|generated with\|created by\|created with"; then
    if echo "$COMMIT_MSG" | grep -iq "copilot\|claude\|chatgpt\|gpt\|bard\|gemini"; then
        print_warning "Commit mentions AI generation but may be missing acknowledgment"
        echo "Consider mentioning AI usage explicitly to be transparent:"
        echo ""
        echo "  'Improved with suggestions from GitHub Copilot'"
        echo ""
    fi
fi

# ============================================================================
# VALIDATION 3: Validate commit message format (optional, informational)
# ============================================================================

# Check if message starts with conventional commit format
if ! echo "$COMMIT_MSG" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|chore|ci)(\(.+\))?:"; then
    print_warning "Commit doesn't follow conventional commit format"
    echo "Recommended format: type(scope): description"
    echo "Example: feat(contact): add form validation"
fi

# ============================================================================
# All validations passed
# ============================================================================

print_success "Commit message validation passed"
exit 0
